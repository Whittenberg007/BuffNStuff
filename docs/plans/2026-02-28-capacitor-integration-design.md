# Capacitor Integration Design — BuffNStuff Phase 11

**Date:** 2026-02-28
**Branch:** `feature/phase-11-capacitor`
**Status:** Approved

## Goal

Add Capacitor to BuffNStuff for native Android and iOS builds while preserving the existing SSR web deployment.

## Build Architecture

Dual-target build system using a single codebase:

| Target | Command | Output | Auth | Deployment |
|--------|---------|--------|------|------------|
| Web | `npm run build` | SSR (default) | Middleware + server-side | Vercel |
| Capacitor | `npm run build:cap` | Static export | Client-side auth guard | Android/iOS |

`next.config.ts` conditionally sets `output: 'export'` when `CAPACITOR_BUILD=true` is set. This keeps both modes working from the same codebase without code duplication.

## Capacitor Configuration

```
capacitor.config.ts
├── appId: "com.buffnstuff.app"
├── appName: "BuffNStuff"
├── webDir: "out"              ← Next.js static export directory
├── server.androidScheme: "https"
└── plugins config for StatusBar, SplashScreen, etc.
```

## Capacitor Plugins (Full Suite)

| Plugin | Purpose |
|--------|---------|
| `@capacitor/status-bar` | Native status bar styling (dark theme match) |
| `@capacitor/splash-screen` | Launch screen |
| `@capacitor/app` | Back button handling, URL open events |
| `@capacitor/haptics` | Vibration feedback on set completion, PRs |
| `@capacitor/camera` | Progress photos, food logging |
| `@capacitor/push-notifications` | Workout reminders |
| `@capacitor/local-notifications` | Rest timer alerts, scheduled reminders |

## Client-Side Auth Guard

A `<CapacitorAuthGuard>` component that:

- Detects if running inside Capacitor via `Capacitor.isNativePlatform()`
- On native: checks Supabase session client-side, redirects to login if expired
- On web: does nothing (middleware handles auth)
- Wraps the `(app)` layout so all protected routes are guarded

## Platform Detection Utility

`src/lib/capacitor/platform.ts` providing:

- `isNative()` — running in Capacitor?
- `isAndroid()` / `isIOS()` — platform-specific checks
- Used to conditionally enable native features (haptics, camera, status bar, etc.)

## Native Project Directories

- `android/` — generated by `npx cap add android`
- `ios/` — generated by `npx cap add ios`
- Added to `.gitignore` (regenerable from config)

## Key Constraints

- Next.js static export disables middleware, API routes, and server components
- Capacitor builds use `webDir: "out"` (Next.js static export output)
- Service worker registration should be skipped on native (Capacitor handles caching)
- Google Fonts (`next/font/google`) won't work in static export — need local font fallback or system fonts for Capacitor builds
