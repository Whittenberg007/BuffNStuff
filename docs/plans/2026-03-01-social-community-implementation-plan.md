# Phase 14: Social & Community â€” Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add social features â€” user profiles, follow system with friend codes, activity feed, and emoji reactions â€” the gym buddy experience.

**Architecture:** Supabase-native with polling/pull-to-refresh. Four new tables (user_profiles, follows, activity_feed, reactions) with RLS policies. Feed events auto-generated by hooking into existing database functions. All routes are static (no `[id]` segments) for Capacitor compatibility.

**Tech Stack:** Next.js, Supabase, TypeScript, shadcn/ui, lucide-react, @capacitor/share (already installed), @capacitor/haptics (already installed)

---

### Task 1: Add Database Types

**Files:**
- Modify: `src/types/database.ts`

**Step 1: Add the new social types after existing types (after line 238)**

Add these types to the end of `src/types/database.ts`:

```typescript
// --- Social & Community ---

export type FollowStatus = "pending" | "accepted" | "rejected";

export type FeedEventType =
  | "workout_completed"
  | "pr_hit"
  | "streak_milestone"
  | "badge_earned"
  | "weight_milestone";

export interface UserProfile {
  id: string;
  user_id: string;
  username: string;
  display_name: string | null;
  bio: string | null;
  avatar_url: string | null;
  is_public: boolean;
  friend_code: string;
  created_at: string;
}

export interface Follow {
  id: string;
  follower_id: string;
  following_id: string;
  status: FollowStatus;
  created_at: string;
}

export interface ActivityFeedItem {
  id: string;
  user_id: string;
  event_type: FeedEventType;
  event_data: Record<string, unknown>;
  created_at: string;
  // Joined fields (from queries)
  profile?: UserProfile;
  reactions?: Reaction[];
}

export interface Reaction {
  id: string;
  activity_id: string;
  user_id: string;
  emoji: string;
  created_at: string;
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors related to the new types

**Step 3: Commit**

```bash
git add src/types/database.ts
git commit -m "feat(social): add database types for profiles, follows, feed, reactions"
```

---

### Task 2: Create Profiles Database Module

**Files:**
- Create: `src/lib/database/profiles.ts`

**Step 1: Create the profiles module**

Create `src/lib/database/profiles.ts`:

```typescript
import { createClient } from "@/lib/supabase/client";
import type { UserProfile } from "@/types";

function generateFriendCode(): string {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let code = "";
  for (let i = 0; i < 4; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return `BUFF-${code}`;
}

export async function getMyProfile(): Promise<UserProfile | null> {
  const supabase = createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Not authenticated");

  const { data, error } = await supabase
    .from("user_profiles")
    .select("*")
    .eq("user_id", user.id)
    .single();

  if (error?.code === "PGRST116") return null;
  if (error) throw error;
  return data as UserProfile;
}

export async function createProfile(input: {
  username: string;
  display_name?: string;
  bio?: string;
  is_public?: boolean;
}): Promise<UserProfile> {
  const supabase = createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Not authenticated");

  const { data, error } = await supabase
    .from("user_profiles")
    .insert({
      user_id: user.id,
      username: input.username.toLowerCase().trim(),
      display_name: input.display_name || null,
      bio: input.bio || null,
      is_public: input.is_public ?? false,
      friend_code: generateFriendCode(),
    })
    .select()
    .single();

  if (error) throw error;
  return data as UserProfile;
}

export async function updateProfile(
  profileId: string,
  updates: Partial<Pick<UserProfile, "display_name" | "bio" | "avatar_url" | "is_public">>
): Promise<UserProfile> {
  const supabase = createClient();

  const { data, error } = await supabase
    .from("user_profiles")
    .update(updates)
    .eq("id", profileId)
    .select()
    .single();

  if (error) throw error;
  return data as UserProfile;
}

export async function checkUsernameAvailable(username: string): Promise<boolean> {
  const supabase = createClient();
  const { data } = await supabase
    .from("user_profiles")
    .select("id")
    .eq("username", username.toLowerCase().trim())
    .single();

  return !data;
}

export async function getProfileByUsername(username: string): Promise<UserProfile | null> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("user_profiles")
    .select("*")
    .eq("username", username.toLowerCase().trim())
    .single();

  if (error?.code === "PGRST116") return null;
  if (error) throw error;
  return data as UserProfile;
}

export async function getProfileByFriendCode(code: string): Promise<UserProfile | null> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("user_profiles")
    .select("*")
    .eq("friend_code", code.toUpperCase().trim())
    .single();

  if (error?.code === "PGRST116") return null;
  if (error) throw error;
  return data as UserProfile;
}

export async function getProfileById(profileId: string): Promise<UserProfile | null> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("user_profiles")
    .select("*")
    .eq("id", profileId)
    .single();

  if (error?.code === "PGRST116") return null;
  if (error) throw error;
  return data as UserProfile;
}

export async function getProfileStats(userId: string): Promise<{
  totalWorkouts: number;
  currentStreak: number;
  badgeCount: number;
}> {
  const supabase = createClient();

  const [workoutsRes, badgesRes] = await Promise.all([
    supabase
      .from("workout_sessions")
      .select("id", { count: "exact", head: true })
      .eq("user_id", userId)
      .not("ended_at", "is", null),
    supabase
      .from("user_badges")
      .select("id", { count: "exact", head: true })
      .eq("user_id", userId),
  ]);

  // Import getCurrentStreak dynamically to avoid circular deps
  const { getCurrentStreak } = await import("@/lib/database/stats");
  const currentStreak = await getCurrentStreak();

  return {
    totalWorkouts: workoutsRes.count || 0,
    currentStreak,
    badgeCount: badgesRes.count || 0,
  };
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/lib/database/profiles.ts
git commit -m "feat(social): add profiles database module with CRUD and friend codes"
```

---

### Task 3: Create Follows Database Module

**Files:**
- Create: `src/lib/database/follows.ts`

**Step 1: Create the follows module**

Create `src/lib/database/follows.ts`:

```typescript
import { createClient } from "@/lib/supabase/client";
import type { Follow, UserProfile } from "@/types";

export async function getMyProfileId(): Promise<string | null> {
  const supabase = createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) return null;

  const { data } = await supabase
    .from("user_profiles")
    .select("id")
    .eq("user_id", user.id)
    .single();

  return data?.id || null;
}

export async function followUser(targetProfileId: string): Promise<Follow> {
  const supabase = createClient();
  const myProfileId = await getMyProfileId();
  if (!myProfileId) throw new Error("Profile not set up");

  // Check if target is public
  const { data: targetProfile } = await supabase
    .from("user_profiles")
    .select("is_public")
    .eq("id", targetProfileId)
    .single();

  const status = targetProfile?.is_public ? "accepted" : "pending";

  const { data, error } = await supabase
    .from("follows")
    .insert({
      follower_id: myProfileId,
      following_id: targetProfileId,
      status,
    })
    .select()
    .single();

  if (error) throw error;
  return data as Follow;
}

export async function unfollowUser(targetProfileId: string): Promise<void> {
  const supabase = createClient();
  const myProfileId = await getMyProfileId();
  if (!myProfileId) throw new Error("Profile not set up");

  const { error } = await supabase
    .from("follows")
    .delete()
    .eq("follower_id", myProfileId)
    .eq("following_id", targetProfileId);

  if (error) throw error;
}

export async function acceptFollowRequest(followId: string): Promise<void> {
  const supabase = createClient();

  const { error } = await supabase
    .from("follows")
    .update({ status: "accepted" })
    .eq("id", followId);

  if (error) throw error;
}

export async function rejectFollowRequest(followId: string): Promise<void> {
  const supabase = createClient();

  const { error } = await supabase
    .from("follows")
    .update({ status: "rejected" })
    .eq("id", followId);

  if (error) throw error;
}

export async function getFollowStatus(
  targetProfileId: string
): Promise<"none" | "pending" | "accepted" | "rejected"> {
  const supabase = createClient();
  const myProfileId = await getMyProfileId();
  if (!myProfileId) return "none";

  const { data } = await supabase
    .from("follows")
    .select("status")
    .eq("follower_id", myProfileId)
    .eq("following_id", targetProfileId)
    .single();

  return (data?.status as Follow["status"]) || "none";
}

export async function getPendingRequests(): Promise<
  (Follow & { follower: UserProfile })[]
> {
  const supabase = createClient();
  const myProfileId = await getMyProfileId();
  if (!myProfileId) return [];

  const { data, error } = await supabase
    .from("follows")
    .select("*, follower:user_profiles!follows_follower_id_fkey(*)")
    .eq("following_id", myProfileId)
    .eq("status", "pending")
    .order("created_at", { ascending: false });

  if (error) throw error;
  return (data || []) as (Follow & { follower: UserProfile })[];
}

export async function getPendingRequestCount(): Promise<number> {
  const supabase = createClient();
  const myProfileId = await getMyProfileId();
  if (!myProfileId) return 0;

  const { count, error } = await supabase
    .from("follows")
    .select("id", { count: "exact", head: true })
    .eq("following_id", myProfileId)
    .eq("status", "pending");

  if (error) return 0;
  return count || 0;
}

export async function getFollowerCount(profileId: string): Promise<number> {
  const supabase = createClient();
  const { count } = await supabase
    .from("follows")
    .select("id", { count: "exact", head: true })
    .eq("following_id", profileId)
    .eq("status", "accepted");

  return count || 0;
}

export async function getFollowingCount(profileId: string): Promise<number> {
  const supabase = createClient();
  const { count } = await supabase
    .from("follows")
    .select("id", { count: "exact", head: true })
    .eq("follower_id", profileId)
    .eq("status", "accepted");

  return count || 0;
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/lib/database/follows.ts
git commit -m "feat(social): add follows database module with request management"
```

---

### Task 4: Create Feed Database Module

**Files:**
- Create: `src/lib/database/feed.ts`

**Step 1: Create the feed module**

Create `src/lib/database/feed.ts`:

```typescript
import { createClient } from "@/lib/supabase/client";
import type { ActivityFeedItem, FeedEventType, Reaction } from "@/types";

export async function createFeedEvent(
  eventType: FeedEventType,
  eventData: Record<string, unknown>
): Promise<void> {
  const supabase = createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) return;

  // Only create events if user has a profile (opt-in)
  const { data: profile } = await supabase
    .from("user_profiles")
    .select("id")
    .eq("user_id", user.id)
    .single();

  if (!profile) return;

  await supabase.from("activity_feed").insert({
    user_id: user.id,
    event_type: eventType,
    event_data: eventData,
  });
}

export async function getFeed(
  limit: number = 20,
  offset: number = 0
): Promise<ActivityFeedItem[]> {
  const supabase = createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) return [];

  // Get my profile ID
  const { data: myProfile } = await supabase
    .from("user_profiles")
    .select("id")
    .eq("user_id", user.id)
    .single();

  if (!myProfile) return [];

  // Get IDs of users I follow (accepted only)
  const { data: following } = await supabase
    .from("follows")
    .select("following_id, following:user_profiles!follows_following_id_fkey(user_id)")
    .eq("follower_id", myProfile.id)
    .eq("status", "accepted");

  if (!following?.length) return [];

  const followedUserIds = following
    .map((f) => (f.following as unknown as { user_id: string })?.user_id)
    .filter(Boolean);

  if (!followedUserIds.length) return [];

  // Fetch feed items from followed users
  const { data: items, error } = await supabase
    .from("activity_feed")
    .select("*")
    .in("user_id", followedUserIds)
    .order("created_at", { ascending: false })
    .range(offset, offset + limit - 1);

  if (error) throw error;
  if (!items?.length) return [];

  // Fetch profiles for these items
  const userIds = [...new Set(items.map((i) => i.user_id))];
  const { data: profiles } = await supabase
    .from("user_profiles")
    .select("*")
    .in("user_id", userIds);

  const profileMap = new Map(
    (profiles || []).map((p) => [p.user_id, p])
  );

  // Fetch reactions for these items
  const itemIds = items.map((i) => i.id);
  const { data: reactions } = await supabase
    .from("reactions")
    .select("*")
    .in("activity_id", itemIds);

  const reactionMap = new Map<string, Reaction[]>();
  for (const r of reactions || []) {
    if (!reactionMap.has(r.activity_id)) reactionMap.set(r.activity_id, []);
    reactionMap.get(r.activity_id)!.push(r as Reaction);
  }

  return items.map((item) => ({
    ...item,
    profile: profileMap.get(item.user_id) || undefined,
    reactions: reactionMap.get(item.id) || [],
  })) as ActivityFeedItem[];
}

export async function addReaction(
  activityId: string,
  emoji: string
): Promise<void> {
  const supabase = createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Not authenticated");

  const { error } = await supabase.from("reactions").upsert(
    {
      activity_id: activityId,
      user_id: user.id,
      emoji,
    },
    { onConflict: "activity_id,user_id" }
  );

  if (error) throw error;
}

export async function removeReaction(activityId: string): Promise<void> {
  const supabase = createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Not authenticated");

  const { error } = await supabase
    .from("reactions")
    .delete()
    .eq("activity_id", activityId)
    .eq("user_id", user.id);

  if (error) throw error;
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/lib/database/feed.ts
git commit -m "feat(social): add feed database module with event creation and reactions"
```

---

### Task 5: Create Profile Card Component

**Files:**
- Create: `src/components/community/profile-card.tsx`

**Step 1: Create the profile card component**

Create `src/components/community/profile-card.tsx`:

```tsx
"use client";

import { Card, CardContent } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { Copy, Share2, Lock, Globe } from "lucide-react";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { isNative } from "@/lib/capacitor/platform";
import type { UserProfile } from "@/types";

interface ProfileCardProps {
  profile: UserProfile;
  stats: {
    totalWorkouts: number;
    currentStreak: number;
    badgeCount: number;
  };
  followerCount: number;
  followingCount: number;
  isOwnProfile?: boolean;
}

export function ProfileCard({
  profile,
  stats,
  followerCount,
  followingCount,
  isOwnProfile,
}: ProfileCardProps) {
  const initials = (profile.display_name || profile.username)
    .slice(0, 2)
    .toUpperCase();

  async function handleShareFriendCode() {
    const text = `Add me on BuffNStuff! My friend code: ${profile.friend_code}`;

    if (isNative()) {
      try {
        const { Share } = await import("@capacitor/share");
        await Share.share({ title: "BuffNStuff Friend Code", text });
        return;
      } catch {
        // Fall through to clipboard
      }
    }

    await navigator.clipboard.writeText(text);
    toast.success("Friend code copied to clipboard!");
  }

  return (
    <Card>
      <CardContent className="pt-6">
        <div className="flex items-start gap-4">
          <Avatar className="size-16">
            {profile.avatar_url && (
              <AvatarImage src={profile.avatar_url} alt={profile.username} />
            )}
            <AvatarFallback className="text-lg">{initials}</AvatarFallback>
          </Avatar>

          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2">
              <h2 className="text-lg font-bold truncate">
                {profile.display_name || profile.username}
              </h2>
              {profile.is_public ? (
                <Globe className="size-3.5 text-muted-foreground" />
              ) : (
                <Lock className="size-3.5 text-muted-foreground" />
              )}
            </div>
            <p className="text-sm text-muted-foreground">@{profile.username}</p>
            {profile.bio && (
              <p className="text-sm mt-1">{profile.bio}</p>
            )}
          </div>
        </div>

        {/* Stats row */}
        <div className="grid grid-cols-4 gap-2 mt-4 text-center">
          <div>
            <p className="text-lg font-bold">{stats.totalWorkouts}</p>
            <p className="text-xs text-muted-foreground">Workouts</p>
          </div>
          <div>
            <p className="text-lg font-bold">{stats.currentStreak}</p>
            <p className="text-xs text-muted-foreground">Streak</p>
          </div>
          <div>
            <p className="text-lg font-bold">{followerCount}</p>
            <p className="text-xs text-muted-foreground">Followers</p>
          </div>
          <div>
            <p className="text-lg font-bold">{followingCount}</p>
            <p className="text-xs text-muted-foreground">Following</p>
          </div>
        </div>

        {/* Badge count */}
        {stats.badgeCount > 0 && (
          <div className="mt-3">
            <Badge variant="secondary">{stats.badgeCount} badges earned</Badge>
          </div>
        )}

        {/* Friend code (own profile only) */}
        {isOwnProfile && (
          <div className="mt-4 flex items-center gap-2 p-2 rounded-md bg-muted">
            <code className="text-sm font-mono flex-1">
              {profile.friend_code}
            </code>
            <Button
              variant="ghost"
              size="icon"
              className="size-8"
              onClick={handleShareFriendCode}
            >
              {isNative() ? (
                <Share2 className="size-4" />
              ) : (
                <Copy className="size-4" />
              )}
            </Button>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/community/profile-card.tsx
git commit -m "feat(social): add profile card component with stats and friend code sharing"
```

---

### Task 6: Create Profile Form Component

**Files:**
- Create: `src/components/community/profile-form.tsx`

**Step 1: Create the profile form component**

Create `src/components/community/profile-form.tsx`:

```tsx
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { Loader2 } from "lucide-react";
import {
  checkUsernameAvailable,
  createProfile,
  updateProfile,
} from "@/lib/database/profiles";
import { toast } from "sonner";
import type { UserProfile } from "@/types";

interface ProfileFormProps {
  existingProfile?: UserProfile | null;
  onSaved: (profile: UserProfile) => void;
}

const USERNAME_REGEX = /^[a-z0-9_]+$/;

export function ProfileForm({ existingProfile, onSaved }: ProfileFormProps) {
  const isEditing = !!existingProfile;

  const [username, setUsername] = useState(existingProfile?.username || "");
  const [displayName, setDisplayName] = useState(
    existingProfile?.display_name || ""
  );
  const [bio, setBio] = useState(existingProfile?.bio || "");
  const [isPublic, setIsPublic] = useState(
    existingProfile?.is_public || false
  );
  const [isSaving, setIsSaving] = useState(false);
  const [usernameError, setUsernameError] = useState("");

  function validateUsername(value: string): string {
    if (value.length < 3) return "Must be at least 3 characters";
    if (value.length > 20) return "Must be 20 characters or less";
    if (!USERNAME_REGEX.test(value))
      return "Only lowercase letters, numbers, and underscores";
    return "";
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    const normalizedUsername = username.toLowerCase().trim();

    const validationError = validateUsername(normalizedUsername);
    if (validationError) {
      setUsernameError(validationError);
      return;
    }

    setIsSaving(true);
    try {
      if (isEditing) {
        const updated = await updateProfile(existingProfile.id, {
          display_name: displayName || null,
          bio: bio || null,
          is_public: isPublic,
        });
        toast.success("Profile updated!");
        onSaved(updated);
      } else {
        // Check username availability
        const available = await checkUsernameAvailable(normalizedUsername);
        if (!available) {
          setUsernameError("Username already taken");
          return;
        }

        const created = await createProfile({
          username: normalizedUsername,
          display_name: displayName || undefined,
          bio: bio || undefined,
          is_public: isPublic,
        });
        toast.success("Profile created!");
        onSaved(created);
      }
    } catch (err) {
      console.error("Profile save failed:", err);
      toast.error("Failed to save profile");
    } finally {
      setIsSaving(false);
    }
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* Username (only editable on creation) */}
      <div className="space-y-2">
        <Label htmlFor="username">Username</Label>
        <Input
          id="username"
          value={username}
          onChange={(e) => {
            const val = e.target.value.toLowerCase();
            setUsername(val);
            setUsernameError(val ? validateUsername(val) : "");
          }}
          placeholder="your_username"
          disabled={isEditing}
          maxLength={20}
        />
        {usernameError && (
          <p className="text-sm text-destructive">{usernameError}</p>
        )}
        {!isEditing && (
          <p className="text-xs text-muted-foreground">
            3-20 characters, lowercase letters, numbers, and underscores only.
            Cannot be changed later.
          </p>
        )}
      </div>

      {/* Display name */}
      <div className="space-y-2">
        <Label htmlFor="displayName">Display Name</Label>
        <Input
          id="displayName"
          value={displayName}
          onChange={(e) => setDisplayName(e.target.value)}
          placeholder="Your Display Name"
          maxLength={50}
        />
      </div>

      {/* Bio */}
      <div className="space-y-2">
        <Label htmlFor="bio">Bio</Label>
        <Textarea
          id="bio"
          value={bio}
          onChange={(e) => setBio(e.target.value)}
          placeholder="Tell us about your fitness journey..."
          maxLength={160}
          rows={3}
        />
        <p className="text-xs text-muted-foreground text-right">
          {bio.length}/160
        </p>
      </div>

      {/* Public toggle */}
      <div className="flex items-center justify-between">
        <div>
          <Label htmlFor="isPublic">Public Profile</Label>
          <p className="text-xs text-muted-foreground">
            Anyone can see your profile and follow without approval
          </p>
        </div>
        <Switch
          id="isPublic"
          checked={isPublic}
          onCheckedChange={setIsPublic}
        />
      </div>

      <Button type="submit" className="w-full" disabled={isSaving}>
        {isSaving && <Loader2 className="size-4 animate-spin mr-2" />}
        {isEditing ? "Update Profile" : "Create Profile"}
      </Button>
    </form>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/community/profile-form.tsx
git commit -m "feat(social): add profile form component with username validation"
```

---

### Task 7: Create Reaction Bar Component

**Files:**
- Create: `src/components/community/reaction-bar.tsx`

**Step 1: Create the reaction bar component**

Create `src/components/community/reaction-bar.tsx`:

```tsx
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { addReaction, removeReaction } from "@/lib/database/feed";
import { isNative } from "@/lib/capacitor/platform";
import type { Reaction } from "@/types";

const EMOJIS = ["ðŸ’ª", "ðŸ”¥", "ðŸŽ‰", "ðŸ‘", "ðŸ†"] as const;

interface ReactionBarProps {
  activityId: string;
  reactions: Reaction[];
  currentUserId: string;
  onReactionChange: () => void;
}

export function ReactionBar({
  activityId,
  reactions,
  currentUserId,
  onReactionChange,
}: ReactionBarProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);

  const myReaction = reactions.find((r) => r.user_id === currentUserId);

  // Count per emoji
  const emojiCounts = new Map<string, number>();
  for (const r of reactions) {
    emojiCounts.set(r.emoji, (emojiCounts.get(r.emoji) || 0) + 1);
  }

  async function handleTap(emoji: string) {
    if (isSubmitting) return;
    setIsSubmitting(true);

    try {
      if (myReaction?.emoji === emoji) {
        await removeReaction(activityId);
      } else {
        await addReaction(activityId, emoji);
      }

      if (isNative()) {
        try {
          const { Haptics, ImpactStyle } = await import("@capacitor/haptics");
          await Haptics.impact({ style: ImpactStyle.Light });
        } catch {
          // Haptics not available
        }
      }

      onReactionChange();
    } catch {
      // Silently fail
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <div className="flex items-center gap-1 flex-wrap">
      {EMOJIS.map((emoji) => {
        const count = emojiCounts.get(emoji) || 0;
        const isSelected = myReaction?.emoji === emoji;

        return (
          <Button
            key={emoji}
            variant={isSelected ? "secondary" : "ghost"}
            size="sm"
            className={`h-7 px-2 text-xs gap-1 ${
              isSelected ? "ring-1 ring-primary" : ""
            }`}
            onClick={() => handleTap(emoji)}
            disabled={isSubmitting}
          >
            <span>{emoji}</span>
            {count > 0 && <span>{count}</span>}
          </Button>
        );
      })}
    </div>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/community/reaction-bar.tsx
git commit -m "feat(social): add reaction bar component with emoji reactions and haptics"
```

---

### Task 8: Create Feed Item Component

**Files:**
- Create: `src/components/community/feed-item.tsx`

**Step 1: Create the feed item component**

Create `src/components/community/feed-item.tsx`:

```tsx
"use client";

import { Card, CardContent } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { ReactionBar } from "./reaction-bar";
import { formatDistanceToNow } from "date-fns";
import {
  Dumbbell,
  Trophy,
  Flame,
  Award,
  Scale,
} from "lucide-react";
import type { ActivityFeedItem, FeedEventType } from "@/types";
import Link from "next/link";

interface FeedItemProps {
  item: ActivityFeedItem;
  currentUserId: string;
  onReactionChange: () => void;
}

function getEventIcon(type: FeedEventType) {
  switch (type) {
    case "workout_completed":
      return <Dumbbell className="size-4 text-blue-500" />;
    case "pr_hit":
      return <Trophy className="size-4 text-yellow-500" />;
    case "streak_milestone":
      return <Flame className="size-4 text-orange-500" />;
    case "badge_earned":
      return <Award className="size-4 text-purple-500" />;
    case "weight_milestone":
      return <Scale className="size-4 text-green-500" />;
  }
}

function getEventText(item: ActivityFeedItem): string {
  const name = item.profile?.display_name || item.profile?.username || "Someone";
  const d = item.event_data;

  switch (item.event_type) {
    case "workout_completed":
      return `${name} finished ${d.split_type || "a workout"} â€” ${d.total_sets} sets, ${d.total_volume} lbs volume`;
    case "pr_hit":
      return `${name} hit a PR! ${d.exercise_name}: ${d.weight} ${d.unit || "lbs"} Ã— ${d.reps}`;
    case "streak_milestone":
      return `${name} reached a ${d.streak_count}-day workout streak`;
    case "badge_earned":
      return `${name} earned ${d.badge_label}`;
    case "weight_milestone":
      return `${name} hit a weight goal!`;
    default:
      return `${name} did something awesome`;
  }
}

export function FeedItem({ item, currentUserId, onReactionChange }: FeedItemProps) {
  const initials = (item.profile?.display_name || item.profile?.username || "?")
    .slice(0, 2)
    .toUpperCase();

  const timeAgo = formatDistanceToNow(new Date(item.created_at), {
    addSuffix: true,
  });

  return (
    <Card>
      <CardContent className="pt-4">
        <div className="flex items-start gap-3">
          <Link href={`/community/user?id=${item.profile?.id}`}>
            <Avatar className="size-10">
              {item.profile?.avatar_url && (
                <AvatarImage
                  src={item.profile.avatar_url}
                  alt={item.profile.username}
                />
              )}
              <AvatarFallback className="text-sm">{initials}</AvatarFallback>
            </Avatar>
          </Link>

          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2">
              {getEventIcon(item.event_type)}
              <p className="text-sm">{getEventText(item)}</p>
            </div>
            <p className="text-xs text-muted-foreground mt-1">{timeAgo}</p>

            <div className="mt-2">
              <ReactionBar
                activityId={item.id}
                reactions={item.reactions || []}
                currentUserId={currentUserId}
                onReactionChange={onReactionChange}
              />
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/community/feed-item.tsx
git commit -m "feat(social): add feed item component with event display and reactions"
```

---

### Task 9: Create Activity Feed Component

**Files:**
- Create: `src/components/community/activity-feed.tsx`

**Step 1: Create the activity feed component**

Create `src/components/community/activity-feed.tsx`:

```tsx
"use client";

import { useCallback, useEffect, useState } from "react";
import { Button } from "@/components/ui/button";
import { RefreshCw, Loader2 } from "lucide-react";
import { FeedItem } from "./feed-item";
import { getFeed } from "@/lib/database/feed";
import { createClient } from "@/lib/supabase/client";
import type { ActivityFeedItem } from "@/types";

const PAGE_SIZE = 20;

export function ActivityFeed() {
  const [items, setItems] = useState<ActivityFeedItem[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isLoadingMore, setIsLoadingMore] = useState(false);
  const [hasMore, setHasMore] = useState(true);
  const [currentUserId, setCurrentUserId] = useState("");

  const loadFeed = useCallback(async (reset = false) => {
    if (reset) setIsLoading(true);

    try {
      const supabase = createClient();
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (user) setCurrentUserId(user.id);

      const offset = reset ? 0 : items.length;
      const newItems = await getFeed(PAGE_SIZE, offset);

      if (reset) {
        setItems(newItems);
      } else {
        setItems((prev) => [...prev, ...newItems]);
      }
      setHasMore(newItems.length === PAGE_SIZE);
    } catch {
      // Silently handle errors
    } finally {
      setIsLoading(false);
      setIsLoadingMore(false);
    }
  }, [items.length]);

  useEffect(() => {
    loadFeed(true);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  function handleRefresh() {
    loadFeed(true);
  }

  function handleLoadMore() {
    setIsLoadingMore(true);
    loadFeed(false);
  }

  if (isLoading) {
    return (
      <div className="text-center py-8 text-sm text-muted-foreground">
        <Loader2 className="size-5 animate-spin mx-auto mb-2" />
        Loading feed...
      </div>
    );
  }

  return (
    <div className="space-y-3">
      <div className="flex justify-end">
        <Button
          variant="ghost"
          size="sm"
          className="gap-1"
          onClick={handleRefresh}
        >
          <RefreshCw className="size-3.5" />
          Refresh
        </Button>
      </div>

      {items.length === 0 ? (
        <div className="text-center py-8 text-sm text-muted-foreground">
          No activity yet. Follow some friends to see their workouts here!
        </div>
      ) : (
        <>
          {items.map((item) => (
            <FeedItem
              key={item.id}
              item={item}
              currentUserId={currentUserId}
              onReactionChange={() => loadFeed(true)}
            />
          ))}

          {hasMore && (
            <Button
              variant="outline"
              className="w-full"
              onClick={handleLoadMore}
              disabled={isLoadingMore}
            >
              {isLoadingMore ? (
                <Loader2 className="size-4 animate-spin mr-2" />
              ) : null}
              Load More
            </Button>
          )}
        </>
      )}
    </div>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/community/activity-feed.tsx
git commit -m "feat(social): add activity feed component with pagination and refresh"
```

---

### Task 10: Create Follow Button Component

**Files:**
- Create: `src/components/community/follow-button.tsx`

**Step 1: Create the follow button component**

Create `src/components/community/follow-button.tsx`:

```tsx
"use client";

import { useEffect, useState } from "react";
import { Button } from "@/components/ui/button";
import { Loader2, UserPlus, UserCheck, Clock } from "lucide-react";
import { followUser, unfollowUser, getFollowStatus } from "@/lib/database/follows";
import { toast } from "sonner";

interface FollowButtonProps {
  targetProfileId: string;
  onFollowChange?: () => void;
}

export function FollowButton({
  targetProfileId,
  onFollowChange,
}: FollowButtonProps) {
  const [status, setStatus] = useState<
    "none" | "pending" | "accepted" | "rejected" | "loading"
  >("loading");
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    getFollowStatus(targetProfileId).then(setStatus);
  }, [targetProfileId]);

  async function handleFollow() {
    setIsSubmitting(true);
    try {
      await followUser(targetProfileId);
      const newStatus = await getFollowStatus(targetProfileId);
      setStatus(newStatus);
      toast.success(
        newStatus === "accepted" ? "Following!" : "Follow request sent!"
      );
      onFollowChange?.();
    } catch {
      toast.error("Failed to follow user");
    } finally {
      setIsSubmitting(false);
    }
  }

  async function handleUnfollow() {
    setIsSubmitting(true);
    try {
      await unfollowUser(targetProfileId);
      setStatus("none");
      toast.success("Unfollowed");
      onFollowChange?.();
    } catch {
      toast.error("Failed to unfollow user");
    } finally {
      setIsSubmitting(false);
    }
  }

  if (status === "loading") {
    return (
      <Button variant="outline" size="sm" disabled>
        <Loader2 className="size-4 animate-spin" />
      </Button>
    );
  }

  if (status === "accepted") {
    return (
      <Button
        variant="secondary"
        size="sm"
        className="gap-1"
        onClick={handleUnfollow}
        disabled={isSubmitting}
      >
        <UserCheck className="size-4" />
        Following
      </Button>
    );
  }

  if (status === "pending") {
    return (
      <Button
        variant="outline"
        size="sm"
        className="gap-1"
        onClick={handleUnfollow}
        disabled={isSubmitting}
      >
        <Clock className="size-4" />
        Pending
      </Button>
    );
  }

  return (
    <Button
      size="sm"
      className="gap-1"
      onClick={handleFollow}
      disabled={isSubmitting}
    >
      {isSubmitting ? (
        <Loader2 className="size-4 animate-spin" />
      ) : (
        <UserPlus className="size-4" />
      )}
      Follow
    </Button>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/community/follow-button.tsx
git commit -m "feat(social): add follow button component with status management"
```

---

### Task 11: Create User Search Component

**Files:**
- Create: `src/components/community/user-search.tsx`

**Step 1: Create the user search component**

Create `src/components/community/user-search.tsx`:

```tsx
"use client";

import { useState } from "react";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Search, Loader2 } from "lucide-react";
import {
  getProfileByUsername,
  getProfileByFriendCode,
} from "@/lib/database/profiles";
import { FollowButton } from "./follow-button";
import Link from "next/link";
import type { UserProfile } from "@/types";

export function UserSearch() {
  const [query, setQuery] = useState("");
  const [result, setResult] = useState<UserProfile | null | undefined>(
    undefined
  );
  const [isSearching, setIsSearching] = useState(false);

  async function handleSearch(e: React.FormEvent) {
    e.preventDefault();
    const trimmed = query.trim();
    if (!trimmed) return;

    setIsSearching(true);
    setResult(undefined);

    try {
      let profile: UserProfile | null = null;

      // Check if it looks like a friend code (BUFF-XXXX format)
      if (/^BUFF-[A-Z0-9]{4}$/i.test(trimmed)) {
        profile = await getProfileByFriendCode(trimmed);
      } else {
        profile = await getProfileByUsername(trimmed);
      }

      setResult(profile);
    } catch {
      setResult(null);
    } finally {
      setIsSearching(false);
    }
  }

  return (
    <div className="space-y-4">
      <form onSubmit={handleSearch} className="flex gap-2">
        <Input
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="Username or friend code (BUFF-XXXX)"
          className="flex-1"
        />
        <Button type="submit" disabled={isSearching || !query.trim()}>
          {isSearching ? (
            <Loader2 className="size-4 animate-spin" />
          ) : (
            <Search className="size-4" />
          )}
        </Button>
      </form>

      {result === null && (
        <p className="text-sm text-muted-foreground text-center py-4">
          No user found. Try a different username or friend code.
        </p>
      )}

      {result && (
        <Card>
          <CardContent className="pt-4">
            <div className="flex items-center gap-3">
              <Link href={`/community/user?id=${result.id}`}>
                <Avatar className="size-10">
                  {result.avatar_url && (
                    <AvatarImage
                      src={result.avatar_url}
                      alt={result.username}
                    />
                  )}
                  <AvatarFallback>
                    {(result.display_name || result.username)
                      .slice(0, 2)
                      .toUpperCase()}
                  </AvatarFallback>
                </Avatar>
              </Link>
              <div className="flex-1 min-w-0">
                <Link href={`/community/user?id=${result.id}`}>
                  <p className="font-medium truncate">
                    {result.display_name || result.username}
                  </p>
                  <p className="text-sm text-muted-foreground">
                    @{result.username}
                  </p>
                </Link>
              </div>
              <FollowButton targetProfileId={result.id} />
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/community/user-search.tsx
git commit -m "feat(social): add user search component with username and friend code lookup"
```

---

### Task 12: Create Request List Component

**Files:**
- Create: `src/components/community/request-list.tsx`

**Step 1: Create the request list component**

Create `src/components/community/request-list.tsx`:

```tsx
"use client";

import { useCallback, useEffect, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Check, X, Loader2 } from "lucide-react";
import {
  getPendingRequests,
  acceptFollowRequest,
  rejectFollowRequest,
} from "@/lib/database/follows";
import { toast } from "sonner";
import Link from "next/link";
import type { Follow, UserProfile } from "@/types";

export function RequestList() {
  const [requests, setRequests] = useState<
    (Follow & { follower: UserProfile })[]
  >([]);
  const [isLoading, setIsLoading] = useState(true);
  const [processingId, setProcessingId] = useState<string | null>(null);

  const loadRequests = useCallback(async () => {
    try {
      const data = await getPendingRequests();
      setRequests(data);
    } catch {
      // Silently handle
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    loadRequests();
  }, [loadRequests]);

  async function handleAccept(followId: string) {
    setProcessingId(followId);
    try {
      await acceptFollowRequest(followId);
      toast.success("Follow request accepted!");
      await loadRequests();
    } catch {
      toast.error("Failed to accept request");
    } finally {
      setProcessingId(null);
    }
  }

  async function handleReject(followId: string) {
    setProcessingId(followId);
    try {
      await rejectFollowRequest(followId);
      toast.success("Follow request rejected");
      await loadRequests();
    } catch {
      toast.error("Failed to reject request");
    } finally {
      setProcessingId(null);
    }
  }

  if (isLoading) {
    return (
      <div className="text-center py-8 text-sm text-muted-foreground">
        <Loader2 className="size-5 animate-spin mx-auto mb-2" />
        Loading requests...
      </div>
    );
  }

  if (requests.length === 0) {
    return (
      <div className="text-center py-8 text-sm text-muted-foreground">
        No pending follow requests.
      </div>
    );
  }

  return (
    <div className="space-y-3">
      {requests.map((req) => (
        <Card key={req.id}>
          <CardContent className="pt-4">
            <div className="flex items-center gap-3">
              <Link href={`/community/user?id=${req.follower.id}`}>
                <Avatar className="size-10">
                  {req.follower.avatar_url && (
                    <AvatarImage
                      src={req.follower.avatar_url}
                      alt={req.follower.username}
                    />
                  )}
                  <AvatarFallback>
                    {(req.follower.display_name || req.follower.username)
                      .slice(0, 2)
                      .toUpperCase()}
                  </AvatarFallback>
                </Avatar>
              </Link>
              <div className="flex-1 min-w-0">
                <p className="font-medium truncate">
                  {req.follower.display_name || req.follower.username}
                </p>
                <p className="text-sm text-muted-foreground">
                  @{req.follower.username}
                </p>
              </div>
              <div className="flex gap-2">
                <Button
                  size="icon"
                  variant="default"
                  className="size-8"
                  onClick={() => handleAccept(req.id)}
                  disabled={processingId === req.id}
                >
                  {processingId === req.id ? (
                    <Loader2 className="size-4 animate-spin" />
                  ) : (
                    <Check className="size-4" />
                  )}
                </Button>
                <Button
                  size="icon"
                  variant="outline"
                  className="size-8"
                  onClick={() => handleReject(req.id)}
                  disabled={processingId === req.id}
                >
                  <X className="size-4" />
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/community/request-list.tsx
git commit -m "feat(social): add request list component for pending follow requests"
```

---

### Task 13: Create Community Feed Page

**Files:**
- Create: `src/app/(app)/community/page.tsx`

**Step 1: Create the community feed page**

Create `src/app/(app)/community/page.tsx`:

```tsx
"use client";

import { useEffect, useState } from "react";
import { Button } from "@/components/ui/button";
import { UserCircle, Search, Bell } from "lucide-react";
import { ActivityFeed } from "@/components/community/activity-feed";
import { getMyProfile } from "@/lib/database/profiles";
import { getPendingRequestCount } from "@/lib/database/follows";
import Link from "next/link";
import type { UserProfile } from "@/types";

export default function CommunityPage() {
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [pendingCount, setPendingCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    async function load() {
      try {
        const [p, count] = await Promise.all([
          getMyProfile(),
          getPendingRequestCount(),
        ]);
        setProfile(p);
        setPendingCount(count);
      } catch {
        // Silently handle
      } finally {
        setIsLoading(false);
      }
    }
    load();
  }, []);

  if (isLoading) {
    return (
      <div className="p-4 md:p-8 max-w-2xl mx-auto">
        <div className="text-center py-8 text-sm text-muted-foreground">
          Loading...
        </div>
      </div>
    );
  }

  // No profile yet â€” prompt to create one
  if (!profile) {
    return (
      <div className="p-4 md:p-8 max-w-2xl mx-auto space-y-6">
        <div>
          <h1 className="text-2xl font-bold">Community</h1>
          <p className="text-sm text-muted-foreground">
            Connect with your gym buddies
          </p>
        </div>
        <div className="text-center py-12 space-y-4">
          <UserCircle className="size-16 mx-auto text-muted-foreground" />
          <div>
            <p className="font-medium">Set up your profile to get started</p>
            <p className="text-sm text-muted-foreground mt-1">
              Create a community profile to follow friends and share your
              progress.
            </p>
          </div>
          <Link href="/community/profile">
            <Button>Create Profile</Button>
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="p-4 md:p-8 max-w-2xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Community</h1>
          <p className="text-sm text-muted-foreground">
            See what your friends are up to
          </p>
        </div>
        <div className="flex gap-2">
          <Link href="/community/requests">
            <Button variant="ghost" size="icon" className="relative">
              <Bell className="size-5" />
              {pendingCount > 0 && (
                <span className="absolute -top-1 -right-1 bg-destructive text-destructive-foreground text-xs rounded-full size-5 flex items-center justify-center">
                  {pendingCount}
                </span>
              )}
            </Button>
          </Link>
          <Link href="/community/find">
            <Button variant="ghost" size="icon">
              <Search className="size-5" />
            </Button>
          </Link>
          <Link href="/community/profile">
            <Button variant="ghost" size="icon">
              <UserCircle className="size-5" />
            </Button>
          </Link>
        </div>
      </div>

      {/* Feed */}
      <ActivityFeed />
    </div>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/app/(app)/community/page.tsx
git commit -m "feat(social): add community feed page with profile gate"
```

---

### Task 14: Create Profile Page

**Files:**
- Create: `src/app/(app)/community/profile/page.tsx`

**Step 1: Create the profile page**

Create `src/app/(app)/community/profile/page.tsx`:

```tsx
"use client";

import { useCallback, useEffect, useState } from "react";
import { Button } from "@/components/ui/button";
import { ArrowLeft, Loader2, Pencil } from "lucide-react";
import { ProfileCard } from "@/components/community/profile-card";
import { ProfileForm } from "@/components/community/profile-form";
import { getMyProfile, getProfileStats } from "@/lib/database/profiles";
import { getFollowerCount, getFollowingCount } from "@/lib/database/follows";
import Link from "next/link";
import type { UserProfile } from "@/types";

export default function ProfilePage() {
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [stats, setStats] = useState({
    totalWorkouts: 0,
    currentStreak: 0,
    badgeCount: 0,
  });
  const [followerCount, setFollowerCount] = useState(0);
  const [followingCount, setFollowingCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [isEditing, setIsEditing] = useState(false);

  const loadProfile = useCallback(async () => {
    try {
      const p = await getMyProfile();
      setProfile(p);

      if (p) {
        const [s, followers, following] = await Promise.all([
          getProfileStats(p.user_id),
          getFollowerCount(p.id),
          getFollowingCount(p.id),
        ]);
        setStats(s);
        setFollowerCount(followers);
        setFollowingCount(following);
      }
    } catch {
      // Silently handle
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    loadProfile();
  }, [loadProfile]);

  function handleProfileSaved(updated: UserProfile) {
    setProfile(updated);
    setIsEditing(false);
    loadProfile();
  }

  if (isLoading) {
    return (
      <div className="p-4 md:p-8 max-w-2xl mx-auto">
        <div className="text-center py-8">
          <Loader2 className="size-5 animate-spin mx-auto" />
        </div>
      </div>
    );
  }

  return (
    <div className="p-4 md:p-8 max-w-2xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-3">
        <Link href="/community">
          <Button variant="ghost" size="icon">
            <ArrowLeft className="size-5" />
          </Button>
        </Link>
        <h1 className="text-2xl font-bold">
          {profile ? "My Profile" : "Create Profile"}
        </h1>
        {profile && !isEditing && (
          <Button
            variant="ghost"
            size="icon"
            className="ml-auto"
            onClick={() => setIsEditing(true)}
          >
            <Pencil className="size-4" />
          </Button>
        )}
      </div>

      {/* Show form for creation or editing */}
      {!profile || isEditing ? (
        <ProfileForm
          existingProfile={profile}
          onSaved={handleProfileSaved}
        />
      ) : (
        <ProfileCard
          profile={profile}
          stats={stats}
          followerCount={followerCount}
          followingCount={followingCount}
          isOwnProfile
        />
      )}
    </div>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/app/(app)/community/profile/page.tsx
git commit -m "feat(social): add own profile page with view and edit modes"
```

---

### Task 15: Create Requests Page

**Files:**
- Create: `src/app/(app)/community/requests/page.tsx`

**Step 1: Create the requests page**

Create `src/app/(app)/community/requests/page.tsx`:

```tsx
"use client";

import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import { RequestList } from "@/components/community/request-list";
import Link from "next/link";

export default function RequestsPage() {
  return (
    <div className="p-4 md:p-8 max-w-2xl mx-auto space-y-6">
      <div className="flex items-center gap-3">
        <Link href="/community">
          <Button variant="ghost" size="icon">
            <ArrowLeft className="size-5" />
          </Button>
        </Link>
        <h1 className="text-2xl font-bold">Follow Requests</h1>
      </div>

      <RequestList />
    </div>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/app/(app)/community/requests/page.tsx
git commit -m "feat(social): add follow requests page"
```

---

### Task 16: Create Find Users Page

**Files:**
- Create: `src/app/(app)/community/find/page.tsx`

**Step 1: Create the find users page**

Create `src/app/(app)/community/find/page.tsx`:

```tsx
"use client";

import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import { UserSearch } from "@/components/community/user-search";
import Link from "next/link";

export default function FindUsersPage() {
  return (
    <div className="p-4 md:p-8 max-w-2xl mx-auto space-y-6">
      <div className="flex items-center gap-3">
        <Link href="/community">
          <Button variant="ghost" size="icon">
            <ArrowLeft className="size-5" />
          </Button>
        </Link>
        <div>
          <h1 className="text-2xl font-bold">Find Friends</h1>
          <p className="text-sm text-muted-foreground">
            Search by username or enter a friend code
          </p>
        </div>
      </div>

      <UserSearch />
    </div>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/app/(app)/community/find/page.tsx
git commit -m "feat(social): add find users page with search"
```

---

### Task 17: Create View User Profile Page

**Files:**
- Create: `src/app/(app)/community/user/page.tsx`

**Step 1: Create the view user page**

Create `src/app/(app)/community/user/page.tsx`:

```tsx
"use client";

import { useCallback, useEffect, useState } from "react";
import { useSearchParams } from "next/navigation";
import { Button } from "@/components/ui/button";
import { ArrowLeft, Loader2 } from "lucide-react";
import { ProfileCard } from "@/components/community/profile-card";
import { FollowButton } from "@/components/community/follow-button";
import { getProfileById, getProfileStats } from "@/lib/database/profiles";
import { getFollowerCount, getFollowingCount } from "@/lib/database/follows";
import Link from "next/link";
import type { UserProfile } from "@/types";

export default function ViewUserPage() {
  const searchParams = useSearchParams();
  const profileId = searchParams.get("id");

  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [stats, setStats] = useState({
    totalWorkouts: 0,
    currentStreak: 0,
    badgeCount: 0,
  });
  const [followerCount, setFollowerCount] = useState(0);
  const [followingCount, setFollowingCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);

  const loadUser = useCallback(async () => {
    if (!profileId) {
      setIsLoading(false);
      return;
    }

    try {
      const p = await getProfileById(profileId);
      setProfile(p);

      if (p) {
        const [s, followers, following] = await Promise.all([
          getProfileStats(p.user_id),
          getFollowerCount(p.id),
          getFollowingCount(p.id),
        ]);
        setStats(s);
        setFollowerCount(followers);
        setFollowingCount(following);
      }
    } catch {
      // Silently handle
    } finally {
      setIsLoading(false);
    }
  }, [profileId]);

  useEffect(() => {
    loadUser();
  }, [loadUser]);

  if (isLoading) {
    return (
      <div className="p-4 md:p-8 max-w-2xl mx-auto">
        <div className="text-center py-8">
          <Loader2 className="size-5 animate-spin mx-auto" />
        </div>
      </div>
    );
  }

  if (!profile) {
    return (
      <div className="p-4 md:p-8 max-w-2xl mx-auto space-y-6">
        <div className="flex items-center gap-3">
          <Link href="/community">
            <Button variant="ghost" size="icon">
              <ArrowLeft className="size-5" />
            </Button>
          </Link>
          <h1 className="text-2xl font-bold">User Not Found</h1>
        </div>
        <p className="text-sm text-muted-foreground text-center py-8">
          This user profile could not be found.
        </p>
      </div>
    );
  }

  return (
    <div className="p-4 md:p-8 max-w-2xl mx-auto space-y-6">
      <div className="flex items-center gap-3">
        <Link href="/community">
          <Button variant="ghost" size="icon">
            <ArrowLeft className="size-5" />
          </Button>
        </Link>
        <h1 className="text-2xl font-bold truncate flex-1">
          {profile.display_name || profile.username}
        </h1>
        <FollowButton
          targetProfileId={profile.id}
          onFollowChange={loadUser}
        />
      </div>

      <ProfileCard
        profile={profile}
        stats={stats}
        followerCount={followerCount}
        followingCount={followingCount}
      />
    </div>
  );
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/app/(app)/community/user/page.tsx
git commit -m "feat(social): add view other user profile page"
```

---

### Task 18: Hook Feed Events Into Existing Functions

**Files:**
- Modify: `src/lib/database/workouts.ts` (endWorkoutSession)
- Modify: `src/lib/training/badges.ts` (awardBadge)
- Modify: `src/lib/database/weight.ts` (logWeight)

**Step 1: Add feed event to endWorkoutSession**

In `src/lib/database/workouts.ts`, modify the `endWorkoutSession` function. After the existing `return data as WorkoutSession;` line (currently line 44), add a feed event creation. Replace the function:

Find the existing `endWorkoutSession` function (lines 32-45) and replace it with:

```typescript
export async function endWorkoutSession(
  sessionId: string
): Promise<WorkoutSession> {
  const supabase = createClient();
  const { data, error } = await supabase
    .from("workout_sessions")
    .update({ ended_at: new Date().toISOString() })
    .eq("id", sessionId)
    .select()
    .single();
  if (error) throw error;

  const session = data as WorkoutSession;

  // Create feed event for workout completion
  try {
    const { data: sets } = await supabase
      .from("workout_sets")
      .select("weight, reps")
      .eq("session_id", sessionId);

    const totalSets = sets?.length || 0;
    const totalVolume = (sets || []).reduce(
      (sum, s) => sum + s.weight * s.reps,
      0
    );

    const { createFeedEvent } = await import("@/lib/database/feed");
    await createFeedEvent("workout_completed", {
      split_type: session.split_type,
      total_sets: totalSets,
      total_volume: totalVolume,
    });
  } catch {
    // Feed event creation should never block the main flow
  }

  return session;
}
```

**Step 2: Add feed event to awardBadge in badges.ts**

In `src/lib/training/badges.ts`, find the `awardBadge` function (lines 93-106). Add a feed event after the badge is inserted. Replace the function:

```typescript
async function awardBadge(
  userId: string,
  badgeType: string,
  context: Record<string, unknown> = {}
): Promise<void> {
  const supabase = createClient();
  await supabase.from("user_badges").insert({
    user_id: userId,
    badge_type: badgeType,
    earned_at: new Date().toISOString(),
    context,
  });

  // Create feed event for badge earned
  try {
    const badge = BADGES.find((b) => b.type === badgeType);
    const { createFeedEvent } = await import("@/lib/database/feed");
    await createFeedEvent("badge_earned", {
      badge_type: badgeType,
      badge_label: badge?.label || badgeType,
    });
  } catch {
    // Feed event creation should never block badge award
  }
}
```

Note: The `BADGES` array is defined earlier in the file (around lines 12-73). The `awardBadge` function already has access to it.

**Step 3: Add feed event for streak milestones in evaluateBadges**

In `src/lib/training/badges.ts`, inside the `evaluateBadges` function, find where streak badges are checked (around lines 130-136, where it checks streak thresholds like 3, 7, 14, 30). After the streak badge is awarded, add a streak milestone feed event.

Find the streak badge section and add after each streak badge award:

```typescript
// Inside evaluateBadges, after awarding a streak badge:
// After the line that awards iron_streak_7, iron_streak_14, iron_streak_30:
try {
  const STREAK_MILESTONES = [7, 14, 30, 60, 90];
  if (STREAK_MILESTONES.includes(streak)) {
    const { createFeedEvent } = await import("@/lib/database/feed");
    await createFeedEvent("streak_milestone", {
      streak_count: streak,
    });
  }
} catch {
  // Feed event should never block badge evaluation
}
```

Add this block right after the streak badge evaluation loop in evaluateBadges completes (after the streak checks but before moving on to other badge types).

**Step 4: Add feed event to logWeight in weight.ts**

In `src/lib/database/weight.ts`, at the end of the `logWeight` function, add a check for weight goals. The function currently returns on lines 31 and 45. Add a feed event check before each return.

Add a helper function at the top of `weight.ts` (after imports):

```typescript
async function checkWeightGoalAndNotify(userId: string): Promise<void> {
  try {
    const supabase = createClient();
    // Check if any weight goal was just achieved
    const { data: goals } = await supabase
      .from("goals")
      .select("id, target_value, current_value, status")
      .eq("user_id", userId)
      .eq("type", "weight")
      .eq("status", "active");

    if (!goals?.length) return;

    const { data: latest } = await supabase
      .from("weight_entries")
      .select("weight")
      .eq("user_id", userId)
      .order("date", { ascending: false })
      .limit(1)
      .single();

    if (!latest) return;

    for (const goal of goals) {
      // Check if current weight meets target (works for both gain and loss)
      const targetMet =
        goal.target_value >= goal.current_value
          ? latest.weight >= goal.target_value
          : latest.weight <= goal.target_value;

      if (targetMet) {
        const { createFeedEvent } = await import("@/lib/database/feed");
        await createFeedEvent("weight_milestone", {
          message: "Hit a weight goal!",
        });
        break; // Only one event per weight log
      }
    }
  } catch {
    // Feed event should never block weight logging
  }
}
```

Then add `await checkWeightGoalAndNotify(user.id);` before each `return data as WeightEntry;` in the existing `logWeight` function (both the update and insert branches).

**Step 5: Add PR feed event to workout set logging**

Find where `is_pr` is set in workout set logging. Look in `src/lib/database/workouts.ts` for the function that logs sets (likely `logWorkoutSet` or similar).

After a set is logged with `is_pr: true`, add:

```typescript
if (setData.is_pr) {
  try {
    const { createFeedEvent } = await import("@/lib/database/feed");
    await createFeedEvent("pr_hit", {
      exercise_name: exerciseName,
      weight: setData.weight,
      reps: setData.reps,
      unit: "lbs",
    });
  } catch {
    // Feed event should never block set logging
  }
}
```

Note: The exact location depends on the existing set logging function. The implementer should find where `is_pr` gets set and add the feed event right after.

**Step 6: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 7: Commit**

```bash
git add src/lib/database/workouts.ts src/lib/training/badges.ts src/lib/database/weight.ts
git commit -m "feat(social): hook feed event creation into workout, badge, and weight functions"
```

---

### Task 19: Add Community Tab to Bottom Nav

**Files:**
- Modify: `src/components/layout/bottom-nav.tsx`

**Step 1: Add the Community tab**

In `src/components/layout/bottom-nav.tsx`, add the `Users` import to the lucide-react import line (line 3), and add a Community tab entry to the `tabs` array between Nutrition and Progress (between the entries at current indices 3 and 4).

Add `Users` to the icon imports:

```typescript
import { Home, Dumbbell, BookOpen, Apple, BarChart3, Users } from "lucide-react";
```

Add to the tabs array after the Nutrition entry and before the Progress entry:

```typescript
{ href: "/community", label: "Community", icon: Users },
```

The full tabs array should become:

```typescript
const tabs = [
  { href: "/", label: "Dashboard", icon: Home },
  { href: "/workout", label: "Workout", icon: Dumbbell },
  { href: "/exercises", label: "Exercises", icon: BookOpen },
  { href: "/nutrition", label: "Nutrition", icon: Apple },
  { href: "/community", label: "Community", icon: Users },
  { href: "/progress", label: "Progress", icon: BarChart3 },
];
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/layout/bottom-nav.tsx
git commit -m "feat(social): add Community tab to bottom navigation"
```

---

### Task 20: Final Verification

**Step 1: Run lint**

Run: `npx next lint`
Expected: No errors (warnings are acceptable)

**Step 2: Run SSR build**

Run: `npm run build`
Expected: Build succeeds

**Step 3: Run Capacitor static export build**

Run: `npm run build:cap`
Expected: Build succeeds (all routes are static, no `[id]` segments)

**Step 4: Fix any errors found**

If there are TypeScript or build errors, fix them. Common issues to watch for:
- Supabase join types needing `as unknown as` casts
- Missing imports
- `useSearchParams()` needing `Suspense` boundary

**Step 5: Commit any fixes**

```bash
git add -A
git commit -m "fix(social): resolve build errors"
```
